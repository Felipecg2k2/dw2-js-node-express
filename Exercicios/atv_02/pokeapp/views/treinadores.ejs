<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= titulo %></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .custom-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            padding: 2rem;
            margin-bottom: 2rem;
            border: none;
        }
        
        .btn-group-spaced {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .type-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            background: linear-gradient(135deg, #3498db, #2c3e50);
            color: white;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .equipe-pokemon {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .pokemon-equipe-badge {
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .pokemon-equipe-badge:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        .equipe-vazia {
            color: #6c757d;
            font-style: italic;
        }
        
        /* NOVOS ESTILOS PARA OS SLOTS */
        .equipe-slots {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin: 1rem 0;
        }
        
        .slot-pokemon {
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            padding: 1rem;
            text-align: center;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        .slot-pokemon:hover {
            border-color: #3498db;
            background: #e3f2fd;
        }
        
        .slot-pokemon.preenchido {
            border: 2px solid #28a745;
            background: #f0fff4;
        }
        
        .slot-vazio {
            color: #6c757d;
            font-size: 2rem;
        }
        
        .pokemon-info {
            font-size: 0.9rem;
        }
        
        .pokemon-nome {
            font-weight: bold;
            margin-bottom: 0.25rem;
        }
        
        .pokemon-tipo {
            font-size: 0.8rem;
            color: #6c757d;
        }
        
        .remover-pokemon {
            margin-top: 0.5rem;
            font-size: 0.7rem;
        }

        .cursor-pointer {
            cursor: pointer;
        }
    </style>
</head>
<body>
    <%- include('partials/navbar') %>

    <div class="container mt-4">
        <div class="custom-card">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1>Gerenciar Treinadores Pok√©mon</h1>
                    <p class="text-muted">Sistema completo de gerenciamento de treinadores cadastrados</p>
                </div>
                <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#modalTreinador">
                    ‚ûï Adicionar Treinador
                </button>
            </div>

            <% if (typeof error !== 'undefined' && error) { %>
                <div class="alert alert-danger">
                    <%= error %>
                </div>
            <% } %>

            <!-- LISTA DE TREINADORES -->
            <div class="card shadow-sm">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0">Treinadores Cadastrados</h5>
                </div>
                <div class="card-body p-0">
                    <% if (treinadores && treinadores.length > 0) { %>
                        <table class="table table-striped table-hover mb-0">
                            <thead class="thead-dark">
                                <tr>
                                    <th>Nome</th>
                                    <th>Cidade</th>
                                    <th>Equipe Pok√©mon</th>
                                    <th style="width: 200px;">A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% treinadores.forEach((treinador) => { %>
                                    <tr>
                                        <td><strong><%= treinador.nome %></strong></td>
                                        <td>
                                            <span class="type-badge">
                                                <%= treinador.cidade %>
                                            </span>
                                        </td>
                                        <td>
                                            <div class="equipe-pokemon">
                                                <% 
                                                // TRATAMENTO ROBUSTO da equipe
                                                let equipeArray = [];
                                                try {
                                                    if (treinador.equipe) {
                                                        if (Array.isArray(treinador.equipe)) {
                                                            equipeArray = treinador.equipe;
                                                        } else if (typeof treinador.equipe === 'string') {
                                                            equipeArray = JSON.parse(treinador.equipe);
                                                        }
                                                    }
                                                } catch (error) {
                                                    equipeArray = [];
                                                }
                                                
                                                if (!Array.isArray(equipeArray)) {
                                                    equipeArray = [];
                                                }
                                                
                                                const equipeCompleta = equipeArray.map(pokemonId => 
                                                    pokemons.find(p => p.id == pokemonId)
                                                ).filter(Boolean);
                                                %>
                                                
                                                <% if (equipeCompleta.length > 0) { %>
                                                    <% equipeCompleta.forEach((pokemon) => { %>
                                                        <span class="type-badge pokemon-equipe-badge"
                                                              onclick=`'showPokemonDetails(<%= JSON.stringify(pokemon).replace(/"/g, "&quot;") %>)'`>
                                                            <%= pokemon.nome %>
                                                        </span>
                                                    <% }); %>
                                                    
                                                    <% if (equipeCompleta.length < 6) { %>
                                                        <span class="badge bg-secondary"><%= 6 - equipeCompleta.length %> vazio(s)</span>
                                                    <% } %>
                                                <% } else { %>
                                                    <span class="equipe-vazia">6 slots vazios</span>
                                                <% } %>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="btn-group-spaced">
                                                <!-- BOT√ÉO EDITAR - ATUALIZADO -->
                                                <button class="btn btn-sm btn-outline-warning" 
                                                        data-bs-toggle="modal" 
                                                        data-bs-target="#modalEditarTreinador"
                                                        data-id="<%= treinador.id %>"
                                                        data-nome="<%= treinador.nome %>"
                                                        data-cidade="<%= treinador.cidade %>"
                                                        data-equipe='<%= JSON.stringify(treinador.equipe || []) %>'>
                                                    ‚úèÔ∏è Editar
                                                </button>
                                                
                                                <!-- BOT√ÉO DELETAR -->
                                                <form action="/treinadores/deletar/<%= treinador.id %>" method="POST" class="d-inline">
                                                    <button type="submit" class="btn btn-sm btn-outline-danger" 
                                                            onclick="return confirm('Tem certeza que deseja deletar <%= treinador.nome %>?')">
                                                        üóëÔ∏è Excluir
                                                    </button>
                                                </form>
                                            </div>
                                        </td>
                                    </tr>
                                <% }); %>
                            </tbody>
                        </table>
                    <% } else { %>
                        <div class="p-4 text-center text-muted">
                            <p class="mb-0">Nenhum treinador cadastrado.</p>
                        </div>
                    <% } %>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL ADICIONAR TREINADOR COM SLOTS -->
    <div class="modal fade" id="modalTreinador" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Adicionar Treinador</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form action="/treinadores" method="POST" id="formTreinador">
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Nome do Treinador *</label>
                                    <input type="text" class="form-control" name="nome" placeholder="Ex: Ash Ketchum" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Cidade *</label>
                                    <input type="text" class="form-control" name="cidade" placeholder="Ex: Pallet" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6>Equipe Pok√©mon (<span id="contadorEquipeAdicionar">0</span>/6)</h6>
                                <div class="equipe-slots" id="equipeSlotsAdicionar">
                                    <!-- Slots ser√£o gerados via JavaScript -->
                                </div>
                                <input type="hidden" name="equipe" id="equipeInputAdicionar" value="">
                                <!-- DEBUG TEMPOR√ÅRIO -->
                                <div class="mt-2 p-2 bg-light border rounded">
                                    <small class="text-muted">Debug: <span id="debugEquipeAdicionar">Nenhum Pok√©mon</span></small>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-success">Salvar Treinador</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- MODAL EDITAR TREINADOR COM SLOTS -->
    <div class="modal fade" id="modalEditarTreinador" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Editar Treinador</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form action="/treinadores/editar/" method="POST" id="formEditarTreinador">
                    <div class="modal-body">
                        <input type="hidden" name="id" id="editarTreinadorId">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Nome do Treinador *</label>
                                    <input type="text" class="form-control" name="nome" id="editarTreinadorNome" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Cidade *</label>
                                    <input type="text" class="form-control" name="cidade" id="editarTreinadorCidade" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6>Equipe Pok√©mon (<span id="contadorEquipeEditar">0</span>/6)</h6>
                                <div class="equipe-slots" id="equipeSlotsEditar">
                                    <!-- Slots ser√£o gerados via JavaScript -->
                                </div>
                                <input type="hidden" name="equipe" id="equipeInputEditar" value="">
                                <!-- DEBUG TEMPOR√ÅRIO -->
                                <div class="mt-2 p-2 bg-light border rounded">
                                    <small class="text-muted">Debug: <span id="debugEquipeEditar">Nenhum Pok√©mon</span></small>
                                </div>
                                <!-- BOT√ÉO TESTE TEMPOR√ÅRIO -->
                                <div class="mt-2">
                                    <button type="button" class="btn btn-info btn-sm" onclick="testarEnvioFormulario()">
                                        üîß Testar Envio
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-warning">Atualizar Treinador</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- MODAL SELECIONAR POK√âMON -->
    <div class="modal fade" id="modalSelecionarPokemon" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Selecionar Pok√©mon</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <input type="text" class="form-control" id="filtroPokemon" placeholder="Buscar Pok√©mon...">
                    </div>
                    <div class="pokemon-lista" style="max-height: 300px; overflow-y: auto;">
                        <% pokemons.forEach((pokemon) => { %>
                            <div class="pokemon-item border-bottom py-2 cursor-pointer" 
                                 data-pokemon-id="<%= pokemon.id %>"
                                 data-pokemon-nome="<%= pokemon.nome %>"
                                 data-pokemon-tipo="<%= pokemon.tipo1 %><% if (pokemon.tipo2) { %>/<%= pokemon.tipo2 %><% } %>"
                                 onclick="selecionarPokemon(this)">
                                <strong><%= pokemon.nome %></strong> - #<%= pokemon.numero %>
                                <br>
                                <small class="text-muted"><%= pokemon.tipo1 %><% if (pokemon.tipo2) { %>/<%= pokemon.tipo2 %><% } %></small>
                            </div>
                        <% }); %>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL DETALHES DO POK√âMON -->
    <div class="modal fade" id="modalDetalhesPokemon" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Detalhes do Pok√©mon: <span id="detalhesPokemonNome"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="detail-row">
                                <span class="detail-label">N√∫mero:</span>
                                <span class="detail-value" id="detalhesPokemonNumero"></span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Tipo:</span>
                                <span class="detail-value" id="detalhesPokemonTipo"></span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Altura:</span>
                                <span class="detail-value" id="detalhesPokemonAltura"></span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Peso:</span>
                                <span class="detail-value" id="detalhesPokemonPeso"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="detail-row">
                                <span class="detail-label">Habilidade:</span>
                                <span class="detail-value" id="detalhesPokemonHabilidade"></span>
                            </div>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <div class="detail-row">
                                <span class="detail-label">Descri√ß√£o:</span>
                                <p id="detalhesPokemonDescricao" class="mt-1 text-muted"></p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
<script>
    // Vari√°veis globais
    let slotAtual = null;
    
    // CORRE√á√ÉO: pokemonsData deve ser um array JavaScript, n√£o string
    // REMOVA as aspas extras que estavam tornando string
    const pokemonsData = `<%- JSON.stringify(pokemons) %>`;
    
    console.log('Pok√©mons carregados:', pokemonsData);
    console.log('Tipo:', Array.isArray(pokemonsData) ? 'Array' : typeof pokemonsData);
    console.log('Primeiro Pok√©mon:', pokemonsData[0]);

    // Fun√ß√£o para testar envio do formul√°rio
    function testarEnvioFormulario() {
        const formData = new FormData(document.getElementById('formEditarTreinador'));
        const dados = {};
        for (let [key, value] of formData.entries()) {
            dados[key] = value;
        }
        console.log('=== TESTE DE ENVIO ===');
        console.log('Dados que seriam enviados:', dados);
        console.log('Tipo da equipe:', typeof dados.equipe);
        console.log('Valor do input hidden:', document.getElementById('equipeInputEditar').value);
        
        alert('Verifique o console (F12) para ver os dados de teste');
    }

    // Fun√ß√£o para mostrar detalhes do Pok√©mon
    function showPokemonDetails(pokemon) {
        document.getElementById('detalhesPokemonNome').textContent = pokemon.nome || 'N√£o informado';
        document.getElementById('detalhesPokemonNumero').textContent = pokemon.numero || 'N/A';

        const tipoComplete = pokemon.tipo2 ? 
            `${pokemon.tipo1}/${pokemon.tipo2}` : 
            pokemon.tipo1 || 'N√£o informado';
        document.getElementById('detalhesPokemonTipo').textContent = tipoComplete;

        const altura = pokemon.altura ? `${pokemon.altura} m` : 'N√£o informada';
        document.getElementById('detalhesPokemonAltura').textContent = altura;

        const peso = pokemon.peso ? `${pokemon.peso} kg` : 'N√£o informado';
        document.getElementById('detalhesPokemonPeso').textContent = peso;

        const habilidade = pokemon.habilidade || 'N√£o informada';
        document.getElementById('detalhesPokemonHabilidade').textContent = habilidade;

        const descricao = pokemon.descricao || 'Nenhuma descri√ß√£o dispon√≠vel.';
        document.getElementById('detalhesPokemonDescricao').textContent = descricao;

        const modal = new bootstrap.Modal(document.getElementById('modalDetalhesPokemon'));
        modal.show();
    }

    // Fun√ß√£o para abrir seletor de Pok√©mon
    function abrirSeletorPokemon(slot) {
        slotAtual = slot;
        const modal = new bootstrap.Modal(document.getElementById('modalSelecionarPokemon'));
        modal.show();
    }

    // Fun√ß√£o para selecionar Pok√©mon
    function selecionarPokemon(element) {
        const pokemonId = element.getAttribute('data-pokemon-id');
        const pokemonNome = element.getAttribute('data-pokemon-nome');
        const pokemonTipo = element.getAttribute('data-pokemon-tipo');
        
        if (slotAtual) {
            // Preencher slot
            slotAtual.innerHTML = `
                <div class="pokemon-info">
                    <div class="pokemon-nome">${pokemonNome}</div>
                    <div class="pokemon-tipo">${pokemonTipo}</div>
                </div>
                <button type="button" class="btn btn-sm btn-danger remover-pokemon" onclick="removerPokemon(this)">
                    Remover
                </button>
            `;
            slotAtual.classList.add('preenchido');
            slotAtual.setAttribute('data-pokemon-id', pokemonId);
            
            atualizarEquipeInput();
        }
        
        const modal = bootstrap.Modal.getInstance(document.getElementById('modalSelecionarPokemon'));
        if (modal) {
            modal.hide();
        }
    }

    // Fun√ß√£o para remover Pok√©mon do slot
    function removerPokemon(button) {
        const slot = button.closest('.slot-pokemon');
        slot.innerHTML = '<div class="slot-vazio">+</div>';
        slot.classList.remove('preenchido');
        slot.removeAttribute('data-pokemon-id');
        
        atualizarEquipeInput();
    }

    // Fun√ß√£o para atualizar input hidden da equipe - VERS√ÉO CORRIGIDA
    function atualizarEquipeInput() {
        const modalAtivo = document.querySelector('.modal.show');
        
        if (!modalAtivo) return;
        
        if (modalAtivo.id === 'modalEditarTreinador') {
            const slots = document.querySelectorAll('#equipeSlotsEditar .slot-pokemon[data-pokemon-id]');
            const equipe = Array.from(slots).map(slot => slot.getAttribute('data-pokemon-id'));
            
            console.log('Equipe atual (editar):', equipe);
            
            // CORRE√á√ÉO: Sempre enviar como string com v√≠rgulas
            const equipeString = equipe.join(',');
            
            const contador = document.getElementById('contadorEquipeEditar');
            if (contador) {
                contador.textContent = equipe.length;
            }
            
            const equipeInput = document.getElementById('equipeInputEditar');
            equipeInput.value = equipeString;
            
            console.log('Input hidden definido como:', equipeInput.value);
            
            // Debug
            const debugElement = document.getElementById('debugEquipeEditar');
            if (debugElement) {
                debugElement.textContent = equipe.length > 0 ? equipe.join(', ') : 'Nenhum Pok√©mon';
            }
            
        } else if (modalAtivo.id === 'modalTreinador') {
            const slots = document.querySelectorAll('#equipeSlotsAdicionar .slot-pokemon[data-pokemon-id]');
            const equipe = Array.from(slots).map(slot => slot.getAttribute('data-pokemon-id'));
            
            console.log('Equipe atual (adicionar):', equipe);
            
            // CORRE√á√ÉO: Sempre enviar como string com v√≠rgulas
            const equipeString = equipe.join(',');
            
            const contador = document.getElementById('contadorEquipeAdicionar');
            if (contador) {
                contador.textContent = equipe.length;
            }
            
            const equipeInput = document.getElementById('equipeInputAdicionar');
            equipeInput.value = equipeString;
            
            console.log('Input hidden definido como:', equipeInput.value);
            
            // Debug
            const debugElement = document.getElementById('debugEquipeAdicionar');
            if (debugElement) {
                debugElement.textContent = equipe.length > 0 ? equipe.join(', ') : 'Nenhum Pok√©mon';
            }
        }
    }

    // Fun√ß√£o SEGURA para buscar Pok√©mon - VERS√ÉO CORRIGIDA
    function encontrarPokemonPorId(pokemonId) {
        console.log('=== BUSCANDO POK√âMON ===');
        console.log('pokemonsData:', pokemonsData);
        console.log('Tipo de pokemonsData:', typeof pokemonsData);
        
        // Se pokemonsData √© string, converter para objeto/array
        let pokemonsArray = pokemonsData;
        
        if (typeof pokemonsArray === 'string') {
            try {
                pokemonsArray = JSON.parse(pokemonsArray);
                console.log('pokemonsData convertido de string para:', typeof pokemonsArray);
            } catch (error) {
                console.error('Erro ao converter pokemonsData:', error);
                pokemonsArray = [];
            }
        }
        
        // Garantir que seja array
        if (!Array.isArray(pokemonsArray)) {
            pokemonsArray = [pokemonsArray].filter(Boolean);
        }
        
        console.log('Array final para busca:', pokemonsArray);
        
        // Converter para n√∫mero para compara√ß√£o
        const idNum = parseInt(pokemonId);
        
        // Buscar Pok√©mon
        const pokemon = pokemonsArray.find(p => {
            // Verificar se p existe e tem id
            if (!p || p.id === undefined) {
                console.log('Pok√©mon inv√°lido:', p);
                return false;
            }
            
            // Comparar IDs (ambos como n√∫meros)
            const resultado = parseInt(p.id) === idNum;
            console.log(`Comparando ${parseInt(p.id)} com ${idNum}: ${resultado}`);
            return resultado;
        });
        
        console.log(`Buscando Pok√©mon ID ${pokemonId} (como n√∫mero: ${idNum}) - Encontrado:`, pokemon);
        return pokemon;
    }

    // Inicializa√ß√£o
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM carregado, inicializando modais...');

        // Modal Adicionar
        const modalAdicionar = document.getElementById('modalTreinador');
        if (modalAdicionar) {
            modalAdicionar.addEventListener('show.bs.modal', function() {
                console.log('Modal Adicionar aberto');
                const container = document.getElementById('equipeSlotsAdicionar');
                if (!container) return;
                
                container.innerHTML = '';
                for (let i = 0; i < 6; i++) {
                    const slot = document.createElement('div');
                    slot.className = 'slot-pokemon';
                    slot.innerHTML = '<div class="slot-vazio">+</div>';
                    slot.onclick = function() {
                        abrirSeletorPokemon(this);
                    };
                    container.appendChild(slot);
                }
                document.getElementById('equipeInputAdicionar').value = '';
                document.getElementById('contadorEquipeAdicionar').textContent = '0';
                
                // Debug
                const debugElement = document.getElementById('debugEquipeAdicionar');
                if (debugElement) {
                    debugElement.textContent = 'Nenhum Pok√©mon';
                }
            });
        }

        // Modal Editar - VERS√ÉO CORRIGIDA
        const modalEditar = document.getElementById('modalEditarTreinador');
        if (modalEditar) {
            modalEditar.addEventListener('show.bs.modal', function(event) {
                console.log('=== MODAL EDI√á√ÉO ABERTO ===');
                
                const button = event.relatedTarget;
                if (!button) return;
                
                const id = button.getAttribute('data-id');
                const nome = button.getAttribute('data-nome');
                const cidade = button.getAttribute('data-cidade');
                const equipeString = button.getAttribute('data-equipe');
                
                console.log('Dados do treinador:', { id, nome, cidade, equipeString });
                
                // Processar equipe - CORRE√á√ÉO: Tratar string vazia e arrays
                let equipeArray = [];
                try {
                    if (equipeString && equipeString.trim() !== '') {
                        equipeArray = JSON.parse(equipeString);
                    }
                    if (!Array.isArray(equipeArray)) {
                        equipeArray = [];
                    }
                } catch (error) {
                    console.error('Erro ao parsear equipe:', error);
                    equipeArray = [];
                }
                
                console.log('Equipe processada:', equipeArray);

                // Preencher formul√°rio b√°sico
                document.getElementById('formEditarTreinador').action = `/treinadores/editar/${id}`;
                document.getElementById('editarTreinadorId').value = id;
                document.getElementById('editarTreinadorNome').value = nome;
                document.getElementById('editarTreinadorCidade').value = cidade;
                
                // IMPORTANTE: Definir o input hidden ANTES de preencher os slots
                document.getElementById('equipeInputEditar').value = equipeArray.join(',');

                // Preencher slots da equipe
                const container = document.getElementById('equipeSlotsEditar');
                if (!container) return;
                
                container.innerHTML = '';
                
                for (let i = 0; i < 6; i++) {
                    const slot = document.createElement('div');
                    slot.className = 'slot-pokemon';
                    
                    // Verificar se tem Pok√©mon neste slot
                    if (i < equipeArray.length && equipeArray[i]) {
                        const pokemonId = equipeArray[i];
                        console.log(`Preenchendo slot ${i} com Pok√©mon ID:`, pokemonId);
                        
                        // USAR FUN√á√ÉO SEGURA para buscar Pok√©mon
                        const pokemon = encontrarPokemonPorId(pokemonId);
                        
                        if (pokemon) {
                            console.log('Pok√©mon encontrado:', pokemon.nome);
                            slot.innerHTML = `
                                <div class="pokemon-info">
                                    <div class="pokemon-nome">${pokemon.nome}</div>
                                    <div class="pokemon-tipo">${pokemon.tipo1}${pokemon.tipo2 ? '/' + pokemon.tipo2 : ''}</div>
                                </div>
                                <button type="button" class="btn btn-sm btn-danger remover-pokemon" onclick="removerPokemon(this)">
                                    Remover
                                </button>
                            `;
                            slot.classList.add('preenchido');
                            slot.setAttribute('data-pokemon-id', pokemonId);
                        } else {
                            console.log('Pok√©mon n√£o encontrado, slot vazio');
                            slot.innerHTML = '<div class="slot-vazio">+</div>';
                        }
                    } else {
                        // Slot vazio
                        slot.innerHTML = '<div class="slot-vazio">+</div>';
                    }
                    
                    // Adicionar evento de clique
                    slot.onclick = function() {
                        abrirSeletorPokemon(this);
                    };
                    
                    container.appendChild(slot);
                }
                
                // Atualizar contador
                const slotsPreenchidos = container.querySelectorAll('.slot-pokemon.preenchido').length;
                document.getElementById('contadorEquipeEditar').textContent = slotsPreenchidos;
                
                // Debug
                const debugElement = document.getElementById('debugEquipeEditar');
                if (debugElement) {
                    debugElement.textContent = equipeArray.length > 0 ? equipeArray.join(', ') : 'Nenhum Pok√©mon';
                }
                
                console.log('Modal edi√ß√£o configurado. Slots preenchidos:', slotsPreenchidos);
                console.log('Input hidden value:', document.getElementById('equipeInputEditar').value);
            });
        }

        // Filtro de Pok√©mon
        const filtroPokemon = document.getElementById('filtroPokemon');
        if (filtroPokemon) {
            filtroPokemon.addEventListener('input', function() {
                const filtro = this.value.toLowerCase();
                const itens = document.querySelectorAll('.pokemon-item');
                
                itens.forEach(item => {
                    const nome = item.getAttribute('data-pokemon-nome').toLowerCase();
                    if (nome.includes(filtro)) {
                        item.style.display = 'block';
                    } else {
                        item.style.display = 'none';
                    }
                });
            });
        }
    });
</script>
</body>
</html>