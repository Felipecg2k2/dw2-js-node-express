<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= titulo %></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .custom-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            padding: 2rem;
            margin-bottom: 2rem;
            border: none;
        }
        
        .btn-group-spaced {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .type-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            background: linear-gradient(135deg, #3498db, #2c3e50);
            color: white;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .equipe-pokemon {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
            align-items: center;
        }
        
        .pokemon-equipe-badge {
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .pokemon-equipe-badge:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        .equipe-vazia {
            color: #6c757d;
            font-style: italic;
        }
        
        /* NOVOS ESTILOS PARA OS SLOTS */
        .equipe-slots {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin: 1rem 0;
        }
        
        .slot-pokemon {
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            padding: 1rem;
            text-align: center;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        .slot-pokemon:hover {
            border-color: #3498db;
            background: #e3f2fd;
        }
        
        .slot-pokemon.preenchido {
            border: 2px solid #28a745;
            background: #f0fff4;
        }
        
        .slot-vazio {
            color: #6c757d;
            font-size: 2rem;
        }
        
        .pokemon-info {
            font-size: 0.9rem;
        }
        
        .pokemon-nome {
            font-weight: bold;
            margin-bottom: 0.25rem;
        }
        
        .pokemon-tipo {
            font-size: 0.8rem;
            color: #6c757d;
        }
        
        .remover-pokemon {
            margin-top: 0.5rem;
            font-size: 0.7rem;
        }

        .cursor-pointer {
            cursor: pointer;
        }

        /* NOVOS ESTILOS PARA IMAGENS */
        .treinador-image {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 50%;
            border: 2px solid #dee2e6;
        }
        
        .image-preview {
            max-width: 200px;
            max-height: 200px;
            object-fit: cover;
            border-radius: 8px;
            border: 2px solid #dee2e6;
            display: none;
            margin-top: 10px;
        }
        
        .current-image {
            max-width: 150px;
            max-height: 150px;
            object-fit: cover;
            border-radius: 50%;
            border: 2px solid #28a745;
        }
        
        .no-image {
            width: 60px;
            height: 60px;
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6c757d;
            font-size: 0.8rem;
        }

        .detail-row {
            margin-bottom: 0.75rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .detail-label {
            font-weight: bold;
            color: #555;
            min-width: 120px;
        }
        
        .detail-value {
            color: #333;
        }

        /* ESTILOS PARA A EQUIPE COM IMAGENS DOS POK√âMONS */
        .pokemon-equipe-imagem {
            width: 50px;
            height: 50px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            overflow: hidden;
            position: relative;
        }

        .pokemon-equipe-imagem:hover {
            transform: scale(1.1);
            border-color: #3498db;
            box-shadow: 0 2px 8px rgba(52, 152, 219, 0.3);
        }

        .pokemon-equipe-thumb {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 6px;
        }

        .pokemon-equipe-sem-imagem {
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.2rem;
        }

        .pokemon-equipe-vazio {
            width: 50px;
            height: 50px;
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f8f9fa;
            color: #6c757d;
        }

        .slot-vazio-small {
            font-size: 1.2rem;
            color: #6c757d;
        }

        /* Tooltip personalizado */
        .pokemon-equipe-imagem:hover::after {
            content: attr(title);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
            white-space: nowrap;
            z-index: 1000;
            margin-bottom: 5px;
        }

        .type-badges-container {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
            margin-top: 1rem;
        }
    </style>
</head>
<body>
    <%- include('partials/navbar') %>

    <div class="container mt-4">
        <div class="custom-card">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1>Gerenciar Treinadores Pok√©mon</h1>
                    <p class="text-muted">Sistema completo de gerenciamento de treinadores cadastrados</p>
                </div>
                <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#modalTreinador">
                    ‚ûï Adicionar Treinador
                </button>
            </div>

            <% if (typeof error !== 'undefined' && error) { %>
                <div class="alert alert-danger">
                    <%= error %>
                </div>
            <% } %>

            <!-- LISTA DE TREINADORES -->
            <div class="card shadow-sm">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0">Treinadores Cadastrados</h5>
                </div>
                <div class="card-body p-0">
                    <% if (treinadores && treinadores.length > 0) { %>
                        <table class="table table-striped table-hover mb-0">
                            <thead class="thead-dark">
                                <tr>
                                    <th>Imagem</th>
                                    <th>Nome</th>
                                    <th>Cidade</th>
                                    <th>Equipe Pok√©mon</th>
                                    <th style="width: 200px;">A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% treinadores.forEach((treinador) => { %>
                                    <tr>
                                        <td>
                                            <% if (treinador.imagem) { %>
                                                <img src="<%= treinador.imagem %>" alt="<%= treinador.nome %>" class="treinador-image" 
                                                     onclick="ampliarImagem('<%= treinador.imagem %>', '<%= treinador.nome %>')" style="cursor: pointer;">
                                            <% } else { %>
                                                <div class="no-image">Sem imagem</div>
                                            <% } %>
                                        </td>
                                        <td><strong><%= treinador.nome %></strong></td>
                                        <td>
                                            <span class="type-badge">
                                                <%= treinador.cidade %>
                                            </span>
                                        </td>
                                        <td>
                                            <div class="equipe-pokemon">
                                                <% 
                                                // TRATAMENTO ROBUSTO da equipe
                                                let equipeArray = [];
                                                try {
                                                    if (treinador.equipe) {
                                                        if (Array.isArray(treinador.equipe)) {
                                                            equipeArray = treinador.equipe;
                                                        } else if (typeof treinador.equipe === 'string') {
                                                            equipeArray = JSON.parse(treinador.equipe);
                                                        }
                                                    }
                                                } catch (error) {
                                                    equipeArray = [];
                                                }
                                                
                                                if (!Array.isArray(equipeArray)) {
                                                    equipeArray = [];
                                                }
                                                
                                                const equipeCompleta = equipeArray.map(pokemonId => 
                                                    pokemons.find(p => p.id == pokemonId)
                                                ).filter(Boolean);
                                                %>
                                                
                                                <% if (equipeCompleta.length > 0) { %>
                                                    <% equipeCompleta.forEach((pokemon) => { %>
                                                        <div class="pokemon-equipe-imagem" 
                                                             onclick=`"showPokemonDetails('<%= pokemon.id %>', '<%= pokemon.nome %>', '<%= pokemon.numero %>', '<%= pokemon.tipo1 %>', '<%= pokemon.tipo2 || "" %>', '<%= pokemon.altura || "" %>', '<%= pokemon.peso || "" %>', '<%= pokemon.habilidade || "" %>', '<%= pokemon.descricao || "" %>', '<%= pokemon.imagem || "" %>')"`
                                                             title="<%= pokemon.nome %> - <%= pokemon.tipo1 %><% if (pokemon.tipo2) { %>/<%= pokemon.tipo2 %><% } %>">
                                                            <% if (pokemon.imagem) { %>
                                                                <img src="<%= pokemon.imagem %>" alt="<%= pokemon.nome %>" class="pokemon-equipe-thumb">
                                                            <% } else { %>
                                                                <div class="pokemon-equipe-sem-imagem">
                                                                    <%= pokemon.nome.charAt(0) %>
                                                                </div>
                                                            <% } %>
                                                        </div>
                                                    <% }); %>
                                                    
                                                    <% if (equipeCompleta.length < 6) { %>
                                                        <% for (let i = 0; i < (6 - equipeCompleta.length); i++) { %>
                                                            <div class="pokemon-equipe-vazio" title="Slot vazio">
                                                                <div class="slot-vazio-small">+</div>
                                                            </div>
                                                        <% } %>
                                                    <% } %>
                                                <% } else { %>
                                                    <% for (let i = 0; i < 6; i++) { %>
                                                        <div class="pokemon-equipe-vazio" title="Slot vazio">
                                                            <div class="slot-vazio-small">+</div>
                                                        </div>
                                                    <% } %>
                                                <% } %>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="btn-group-spaced">
                                                <!-- BOT√ÉO EDITAR - ATUALIZADO COM IMAGEM -->
                                                <button class="btn btn-sm btn-outline-warning" 
                                                        data-bs-toggle="modal" 
                                                        data-bs-target="#modalEditarTreinador"
                                                        data-id="<%= treinador.id %>"
                                                        data-nome="<%= treinador.nome %>"
                                                        data-cidade="<%= treinador.cidade %>"
                                                        data-equipe='<%= JSON.stringify(treinador.equipe || []) %>'
                                                        data-imagem="<%= treinador.imagem || '' %>">
                                                    ‚úèÔ∏è Editar
                                                </button>
                                                
                                                <!-- BOT√ÉO DELETAR -->
                                                <form action="/treinadores/deletar/<%= treinador.id %>" method="POST" class="d-inline">
                                                    <button type="submit" class="btn btn-sm btn-outline-danger" 
                                                            onclick="return confirm('Tem certeza que deseja deletar <%= treinador.nome %>?')">
                                                        üóëÔ∏è Excluir
                                                    </button>
                                                </form>
                                            </div>
                                        </td>
                                    </tr>
                                <% }); %>
                            </tbody>
                        </table>
                    <% } else { %>
                        <div class="p-4 text-center text-muted">
                            <p class="mb-0">Nenhum treinador cadastrado.</p>
                        </div>
                    <% } %>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL ADICIONAR TREINADOR COM SLOTS -->
    <div class="modal fade" id="modalTreinador" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Adicionar Treinador</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form action="/treinadores" method="POST" id="formTreinador" enctype="multipart/form-data">
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Nome do Treinador *</label>
                                    <input type="text" class="form-control" name="nome" placeholder="Ex: Ash Ketchum" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Cidade *</label>
                                    <input type="text" class="form-control" name="cidade" placeholder="Ex: Pallet" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Imagem do Treinador</label>
                                    <input type="file" class="form-control" name="imagem" id="imagemInputTreinador" accept="image/*" onchange="previewImage(this, 'previewImagemTreinador')">
                                    <small class="text-muted">Formatos: JPG, PNG, GIF. M√°x: 5MB</small>
                                    <img id="previewImagemTreinador" class="image-preview" alt="Preview da imagem">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6>Equipe Pok√©mon (<span id="contadorEquipeAdicionar">0</span>/6)</h6>
                                <div class="equipe-slots" id="equipeSlotsAdicionar">
                                    <!-- Slots ser√£o gerados via JavaScript -->
                                </div>
                                <input type="hidden" name="equipe" id="equipeInputAdicionar" value="">
                                <!-- DEBUG TEMPOR√ÅRIO -->
                                <div class="mt-2 p-2 bg-light border rounded">
                                    <small class="text-muted">Debug: <span id="debugEquipeAdicionar">Nenhum Pok√©mon</span></small>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-success">Salvar Treinador</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- MODAL EDITAR TREINADOR COM SLOTS -->
    <div class="modal fade" id="modalEditarTreinador" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Editar Treinador</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form action="/treinadores/editar/" method="POST" id="formEditarTreinador" enctype="multipart/form-data">
                    <div class="modal-body">
                        <input type="hidden" name="id" id="editarTreinadorId">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Nome do Treinador *</label>
                                    <input type="text" class="form-control" name="nome" id="editarTreinadorNome" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Cidade *</label>
                                    <input type="text" class="form-control" name="cidade" id="editarTreinadorCidade" required>
                                </div>
                                <!-- NOVO CAMPO: IMAGEM DO TREINADOR NO EDIT -->
                                <div class="mb-3">
                                    <label class="form-label">Imagem do Treinador</label>
                                    
                                    <!-- Imagem atual -->
                                    <div id="currentImageContainerTreinador" class="mb-2">
                                        <small class="text-muted">Imagem atual:</small>
                                        <div id="currentImageTreinador" class="mt-1"></div>
                                    </div>
                                    
                                    <!-- Upload nova imagem -->
                                    <input type="file" class="form-control" name="imagem" id="editarImagemInputTreinador" accept="image/*" onchange="previewImage(this, 'previewEditarImagemTreinador')">
                                    <small class="text-muted">Deixe em branco para manter a imagem atual</small>
                                    <img id="previewEditarImagemTreinador" class="image-preview" alt="Preview da nova imagem">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6>Equipe Pok√©mon (<span id="contadorEquipeEditar">0</span>/6)</h6>
                                <div class="equipe-slots" id="equipeSlotsEditar">
                                    <!-- Slots ser√£o gerados via JavaScript -->
                                </div>
                                <input type="hidden" name="equipe" id="equipeInputEditar" value="">
                                <!-- DEBUG TEMPOR√ÅRIO -->
                                <div class="mt-2 p-2 bg-light border rounded">
                                    <small class="text-muted">Debug: <span id="debugEquipeEditar">Nenhum Pok√©mon</span></small>
                                </div>
                                <!-- BOT√ÉO TESTE TEMPOR√ÅRIO -->
                                <div class="mt-2">
                                    <button type="button" class="btn btn-info btn-sm" onclick="testarEnvioFormulario()">
                                        üîß Testar Envio
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-warning">Atualizar Treinador</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- MODAL SELECIONAR POK√âMON -->
    <div class="modal fade" id="modalSelecionarPokemon" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Selecionar Pok√©mon</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <input type="text" class="form-control" id="filtroPokemon" placeholder="Buscar Pok√©mon...">
                    </div>
                    <div class="pokemon-lista" style="max-height: 300px; overflow-y: auto;">
                        <% pokemons.forEach((pokemon) => { %>
                            <div class="pokemon-item border-bottom py-2 cursor-pointer" 
                                 data-pokemon-id="<%= pokemon.id %>"
                                 data-pokemon-nome="<%= pokemon.nome %>"
                                 data-pokemon-tipo="<%= pokemon.tipo1 %><% if (pokemon.tipo2) { %>/<%= pokemon.tipo2 %><% } %>"
                                 onclick="selecionarPokemon(this)">
                                <strong><%= pokemon.nome %></strong> - #<%= pokemon.numero %>
                                <br>
                                <small class="text-muted"><%= pokemon.tipo1 %><% if (pokemon.tipo2) { %>/<%= pokemon.tipo2 %><% } %></small>
                            </div>
                        <% }); %>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL DETALHES DO POK√âMON -->
    <div class="modal fade" id="modalDetalhesPokemon" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Detalhes do Pok√©mon: <span id="detalhesPokemonNome"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-4 text-center">
                            <!-- IMAGEM GRANDE DO POK√âMON -->
                            <div id="detalhesPokemonImagemContainer" class="mb-3">
                                <img id="detalhesPokemonImagem" src="" alt="" class="img-fluid rounded" style="max-height: 200px; object-fit: cover;">
                            </div>
                            <div class="type-badges-container" id="detalhesPokemonTipos"></div>
                        </div>
                        <div class="col-md-8">
                            <div class="detail-row">
                                <span class="detail-label">N√∫mero:</span>
                                <span class="detail-value" id="detalhesPokemonNumero"></span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Altura:</span>
                                <span class="detail-value" id="detalhesPokemonAltura"></span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Peso:</span>
                                <span class="detail-value" id="detalhesPokemonPeso"></span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Habilidade:</span>
                                <span class="detail-value" id="detalhesPokemonHabilidade"></span>
                            </div>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <div class="detail-row">
                                <span class="detail-label">Descri√ß√£o:</span>
                                <p id="detalhesPokemonDescricao" class="mt-1 text-muted"></p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL PARA AMPLIAR IMAGEM -->
    <div class="modal fade" id="modalAmpliarImagem" tabindex="-1">
        <div class="modal-dialog modal-md">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="tituloImagemAmpliada"></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <img id="imagemAmpliada" src="" alt="" class="img-fluid" style="max-height: 70vh; object-fit: contain;">
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
<script>
    // Vari√°veis globais
    let slotAtual = null;
    
    // CORRE√á√ÉO: pokemonsData deve ser um array JavaScript - REMOVIDAS AS ASPAS
    const pokemonsData = `<%- JSON.stringify(pokemons) %>`;
    
    console.log('Pok√©mons carregados:', pokemonsData);
    console.log('Tipo:', Array.isArray(pokemonsData) ? 'Array' : typeof pokemonsData);

    // Fun√ß√£o para testar envio do formul√°rio
    function testarEnvioFormulario() {
        const formData = new FormData(document.getElementById('formEditarTreinador'));
        const dados = {};
        for (let [key, value] of formData.entries()) {
            dados[key] = value;
        }
        console.log('=== TESTE DE ENVIO ===');
        console.log('Dados que seriam enviados:', dados);
        console.log('Tipo da equipe:', typeof dados.equipe);
        console.log('Valor do input hidden:', document.getElementById('equipeInputEditar').value);
        
        alert('Verifique o console (F12) para ver os dados de teste');
    }

    // Fun√ß√£o para mostrar detalhes do Pok√©mon - VERS√ÉO CORRIGIDA
    function showPokemonDetails(id, nome, numero, tipo1, tipo2, altura, peso, habilidade, descricao, imagem) {
        console.log('Detalhes do Pok√©mon:', { id, nome, numero, tipo1, tipo2, altura, peso, habilidade, descricao, imagem });
        
        document.getElementById('detalhesPokemonNome').textContent = nome || 'N√£o informado';
        document.getElementById('detalhesPokemonNumero').textContent = numero || 'N/A';

        // Mostrar tipos com badges coloridos
        const tiposContainer = document.getElementById('detalhesPokemonTipos');
        if (tipo1) {
            let tiposHTML = `<span class="type-badge" style="background: ${getTipoColor(tipo1)}">${tipo1}</span>`;
            if (tipo2 && tipo2.trim() !== '') {
                tiposHTML += ` <span class="type-badge" style="background: ${getTipoColor(tipo2)}">${tipo2}</span>`;
            }
            tiposContainer.innerHTML = tiposHTML;
        } else {
            tiposContainer.innerHTML = '<span class="text-muted">N√£o informado</span>';
        }

        const alturaText = altura && altura.trim() !== '' ? `${altura} m` : 'N√£o informada';
        document.getElementById('detalhesPokemonAltura').textContent = alturaText;

        const pesoText = peso && peso.trim() !== '' ? `${peso} kg` : 'N√£o informado';
        document.getElementById('detalhesPokemonPeso').textContent = pesoText;

        const habilidadeText = habilidade && habilidade.trim() !== '' ? habilidade : 'N√£o informada';
        document.getElementById('detalhesPokemonHabilidade').textContent = habilidadeText;

        const descricaoText = descricao && descricao.trim() !== '' ? descricao : 'Nenhuma descri√ß√£o dispon√≠vel.';
        document.getElementById('detalhesPokemonDescricao').textContent = descricaoText;

        // Mostrar imagem grande nos detalhes
        const imagemElement = document.getElementById('detalhesPokemonImagem');
        if (imagem && imagem.trim() !== '') {
            imagemElement.src = imagem;
            imagemElement.alt = nome;
            imagemElement.style.display = 'block';
        } else {
            imagemElement.style.display = 'none';
        }

        const modal = new bootstrap.Modal(document.getElementById('modalDetalhesPokemon'));
        modal.show();
    }

    // Fun√ß√£o para obter cores dos tipos Pok√©mon
    function getTipoColor(tipo) {
        const cores = {
            'Normal': '#A8A878',
            'Fogo': '#F08030',
            '√Ågua': '#6890F0',
            'El√©trico': '#F8D030',
            'Grama': '#78C850',
            'Gelo': '#98D8D8',
            'Lutador': '#C03028',
            'Veneno': '#A040A0',
            'Terra': '#E0C068',
            'Voador': '#A890F0',
            'Ps√≠quico': '#F85888',
            'Inseto': '#A8B820',
            'Pedra': '#B8A038',
            'Fantasma': '#705898',
            'Drag√£o': '#7038F8',
            'Sombrio': '#705848',
            'A√ßo': '#B8B8D0',
            'Fada': '#EE99AC'
        };
        return cores[tipo] || '#68A090';
    }

    // Fun√ß√£o para preview de imagem
    function previewImage(input, previewId) {
        const preview = document.getElementById(previewId);
        const file = input.files[0];
        
        if (file) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                preview.src = e.target.result;
                preview.style.display = 'block';
            }
            
            reader.readAsDataURL(file);
        } else {
            preview.style.display = 'none';
        }
    }

    // Fun√ß√£o para ampliar imagem
    function ampliarImagem(src, nome) {
        document.getElementById('imagemAmpliada').src = src;
        document.getElementById('tituloImagemAmpliada').textContent = nome;
        const modal = new bootstrap.Modal(document.getElementById('modalAmpliarImagem'));
        modal.show();
    }

    // Fun√ß√£o para abrir seletor de Pok√©mon
    function abrirSeletorPokemon(slot) {
        slotAtual = slot;
        const modal = new bootstrap.Modal(document.getElementById('modalSelecionarPokemon'));
        modal.show();
    }

    // Fun√ß√£o para selecionar Pok√©mon
    function selecionarPokemon(element) {
        const pokemonId = element.getAttribute('data-pokemon-id');
        const pokemonNome = element.getAttribute('data-pokemon-nome');
        const pokemonTipo = element.getAttribute('data-pokemon-tipo');
        
        if (slotAtual) {
            // Preencher slot
            slotAtual.innerHTML = `
                <div class="pokemon-info">
                    <div class="pokemon-nome">${pokemonNome}</div>
                    <div class="pokemon-tipo">${pokemonTipo}</div>
                </div>
                <button type="button" class="btn btn-sm btn-danger remover-pokemon" onclick="removerPokemon(this)">
                    Remover
                </button>
            `;
            slotAtual.classList.add('preenchido');
            slotAtual.setAttribute('data-pokemon-id', pokemonId);
            
            atualizarEquipeInput();
        }
        
        const modal = bootstrap.Modal.getInstance(document.getElementById('modalSelecionarPokemon'));
        if (modal) {
            modal.hide();
        }
    }

    // Fun√ß√£o para remover Pok√©mon do slot
    function removerPokemon(button) {
        const slot = button.closest('.slot-pokemon');
        slot.innerHTML = '<div class="slot-vazio">+</div>';
        slot.classList.remove('preenchido');
        slot.removeAttribute('data-pokemon-id');
        
        atualizarEquipeInput();
    }

    // Fun√ß√£o para atualizar input hidden da equipe - VERS√ÉO CORRIGIDA
    function atualizarEquipeInput() {
        const modalAtivo = document.querySelector('.modal.show');
        
        if (!modalAtivo) return;
        
        if (modalAtivo.id === 'modalEditarTreinador') {
            const slots = document.querySelectorAll('#equipeSlotsEditar .slot-pokemon[data-pokemon-id]');
            const equipe = Array.from(slots).map(slot => slot.getAttribute('data-pokemon-id'));
            
            console.log('Equipe atual (editar):', equipe);
            
            // CORRE√á√ÉO: Sempre enviar como string com v√≠rgulas
            const equipeString = equipe.join(',');
            
            const contador = document.getElementById('contadorEquipeEditar');
            if (contador) {
                contador.textContent = equipe.length;
            }
            
            const equipeInput = document.getElementById('equipeInputEditar');
            equipeInput.value = equipeString;
            
            console.log('Input hidden definido como:', equipeInput.value);
            
            // Debug
            const debugElement = document.getElementById('debugEquipeEditar');
            if (debugElement) {
                debugElement.textContent = equipe.length > 0 ? equipe.join(', ') : 'Nenhum Pok√©mon';
            }
            
        } else if (modalAtivo.id === 'modalTreinador') {
            const slots = document.querySelectorAll('#equipeSlotsAdicionar .slot-pokemon[data-pokemon-id]');
            const equipe = Array.from(slots).map(slot => slot.getAttribute('data-pokemon-id'));
            
            console.log('Equipe atual (adicionar):', equipe);
            
            // CORRE√á√ÉO: Sempre enviar como string com v√≠rgulas
            const equipeString = equipe.join(',');
            
            const contador = document.getElementById('contadorEquipeAdicionar');
            if (contador) {
                contador.textContent = equipe.length;
            }
            
            const equipeInput = document.getElementById('equipeInputAdicionar');
            equipeInput.value = equipeString;
            
            console.log('Input hidden definido como:', equipeInput.value);
            
            // Debug
            const debugElement = document.getElementById('debugEquipeAdicionar');
            if (debugElement) {
                debugElement.textContent = equipe.length > 0 ? equipe.join(', ') : 'Nenhum Pok√©mon';
            }
        }
    }

    // Fun√ß√£o SEGURA para buscar Pok√©mon - VERS√ÉO CORRIGIDA
    function encontrarPokemonPorId(pokemonId) {
        console.log('=== BUSCANDO POK√âMON ===');
        console.log('pokemonsData:', pokemonsData);
        console.log('Tipo de pokemonsData:', typeof pokemonsData);
        
        // Se pokemonsData √© string, converter para objeto/array
        let pokemonsArray = pokemonsData;
        
        if (typeof pokemonsArray === 'string') {
            try {
                pokemonsArray = JSON.parse(pokemonsArray);
                console.log('pokemonsData convertido de string para:', typeof pokemonsArray);
            } catch (error) {
                console.error('Erro ao converter pokemonsData:', error);
                pokemonsArray = [];
            }
        }
        
        // Garantir que seja array
        if (!Array.isArray(pokemonsArray)) {
            pokemonsArray = [pokemonsArray].filter(Boolean);
        }
        
        console.log('Array final para busca:', pokemonsArray);
        
        // Converter para n√∫mero para compara√ß√£o
        const idNum = parseInt(pokemonId);
        
        // Buscar Pok√©mon
        const pokemon = pokemonsArray.find(p => {
            // Verificar se p existe e tem id
            if (!p || p.id === undefined) {
                console.log('Pok√©mon inv√°lido:', p);
                return false;
            }
            
            // Comparar IDs (ambos como n√∫meros)
            const resultado = parseInt(p.id) === idNum;
            console.log(`Comparando ${parseInt(p.id)} com ${idNum}: ${resultado}`);
            return resultado;
        });
        
        console.log(`Buscando Pok√©mon ID ${pokemonId} (como n√∫mero: ${idNum}) - Encontrado:`, pokemon);
        return pokemon;
    }

    // Inicializa√ß√£o
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM carregado, inicializando modais...');

        // Modal Adicionar
        const modalAdicionar = document.getElementById('modalTreinador');
        if (modalAdicionar) {
            modalAdicionar.addEventListener('show.bs.modal', function() {
                console.log('Modal Adicionar aberto');
                const container = document.getElementById('equipeSlotsAdicionar');
                if (!container) return;
                
                container.innerHTML = '';
                for (let i = 0; i < 6; i++) {
                    const slot = document.createElement('div');
                    slot.className = 'slot-pokemon';
                    slot.innerHTML = '<div class="slot-vazio">+</div>';
                    slot.onclick = function() {
                        abrirSeletorPokemon(this);
                    };
                    container.appendChild(slot);
                }
                document.getElementById('equipeInputAdicionar').value = '';
                document.getElementById('contadorEquipeAdicionar').textContent = '0';
                
                // Debug
                const debugElement = document.getElementById('debugEquipeAdicionar');
                if (debugElement) {
                    debugElement.textContent = 'Nenhum Pok√©mon';
                }

                // Limpar preview de imagem
                document.getElementById('previewImagemTreinador').style.display = 'none';
                document.getElementById('imagemInputTreinador').value = '';
            });
        }

        // Modal Editar - VERS√ÉO CORRIGIDA
        const modalEditar = document.getElementById('modalEditarTreinador');
        if (modalEditar) {
            modalEditar.addEventListener('show.bs.modal', function(event) {
                console.log('=== MODAL EDI√á√ÉO ABERTO ===');
                
                const button = event.relatedTarget;
                if (!button) return;
                
                const id = button.getAttribute('data-id');
                const nome = button.getAttribute('data-nome');
                const cidade = button.getAttribute('data-cidade');
                const equipeString = button.getAttribute('data-equipe');
                const imagem = button.getAttribute('data-imagem');
                
                console.log('Dados do treinador:', { id, nome, cidade, equipeString, imagem });
                
                // Processar equipe - CORRE√á√ÉO: Tratar string vazia e arrays
                let equipeArray = [];
                try {
                    if (equipeString && equipeString.trim() !== '') {
                        equipeArray = JSON.parse(equipeString);
                    }
                    if (!Array.isArray(equipeArray)) {
                        equipeArray = [];
                    }
                } catch (error) {
                    console.error('Erro ao parsear equipe:', error);
                    equipeArray = [];
                }
                
                console.log('Equipe processada:', equipeArray);

                // Preencher formul√°rio b√°sico
                document.getElementById('formEditarTreinador').action = `/treinadores/editar/${id}`;
                document.getElementById('editarTreinadorId').value = id;
                document.getElementById('editarTreinadorNome').value = nome;
                document.getElementById('editarTreinadorCidade').value = cidade;
                
                // IMPORTANTE: Definir o input hidden ANTES de preencher os slots
                document.getElementById('equipeInputEditar').value = equipeArray.join(',');

                // Mostrar imagem atual no edit
                const currentImageContainer = document.getElementById('currentImageTreinador');
                if (imagem) {
                    currentImageContainer.innerHTML = `<img src="${imagem}" alt="${nome}" class="current-image">`;
                } else {
                    currentImageContainer.innerHTML = '<span class="text-muted">Nenhuma imagem</span>';
                }

                // Preencher slots da equipe
                const container = document.getElementById('equipeSlotsEditar');
                if (!container) return;
                
                container.innerHTML = '';
                
                for (let i = 0; i < 6; i++) {
                    const slot = document.createElement('div');
                    slot.className = 'slot-pokemon';
                    
                    // Verificar se tem Pok√©mon neste slot
                    if (i < equipeArray.length && equipeArray[i]) {
                        const pokemonId = equipeArray[i];
                        console.log(`Preenchendo slot ${i} com Pok√©mon ID:`, pokemonId);
                        
                        // USAR FUN√á√ÉO SEGURA para buscar Pok√©mon
                        const pokemon = encontrarPokemonPorId(pokemonId);
                        
                        if (pokemon) {
                            console.log('Pok√©mon encontrado:', pokemon.nome);
                            slot.innerHTML = `
                                <div class="pokemon-info">
                                    <div class="pokemon-nome">${pokemon.nome}</div>
                                    <div class="pokemon-tipo">${pokemon.tipo1}${pokemon.tipo2 ? '/' + pokemon.tipo2 : ''}</div>
                                </div>
                                <button type="button" class="btn btn-sm btn-danger remover-pokemon" onclick="removerPokemon(this)">
                                    Remover
                                </button>
                            `;
                            slot.classList.add('preenchido');
                            slot.setAttribute('data-pokemon-id', pokemonId);
                        } else {
                            console.log('Pok√©mon n√£o encontrado, slot vazio');
                            slot.innerHTML = '<div class="slot-vazio">+</div>';
                        }
                    } else {
                        // Slot vazio
                        slot.innerHTML = '<div class="slot-vazio">+</div>';
                    }
                    
                    // Adicionar evento de clique
                    slot.onclick = function() {
                        abrirSeletorPokemon(this);
                    };
                    
                    container.appendChild(slot);
                }
                
                // Atualizar contador
                const slotsPreenchidos = container.querySelectorAll('.slot-pokemon.preenchido').length;
                document.getElementById('contadorEquipeEditar').textContent = slotsPreenchidos;
                
                // Debug
                const debugElement = document.getElementById('debugEquipeEditar');
                if (debugElement) {
                    debugElement.textContent = equipeArray.length > 0 ? equipeArray.join(', ') : 'Nenhum Pok√©mon';
                }
                
                // Limpar preview de nova imagem
                document.getElementById('previewEditarImagemTreinador').style.display = 'none';
                document.getElementById('editarImagemInputTreinador').value = '';
                
                console.log('Modal edi√ß√£o configurado. Slots preenchidos:', slotsPreenchidos);
                console.log('Input hidden value:', document.getElementById('equipeInputEditar').value);
            });
        }

        // Filtro de Pok√©mon
        const filtroPokemon = document.getElementById('filtroPokemon');
        if (filtroPokemon) {
            filtroPokemon.addEventListener('input', function() {
                const filtro = this.value.toLowerCase();
                const itens = document.querySelectorAll('.pokemon-item');
                
                itens.forEach(item => {
                    const nome = item.getAttribute('data-pokemon-nome').toLowerCase();
                    if (nome.includes(filtro)) {
                        item.style.display = 'block';
                    } else {
                        item.style.display = 'none';
                    }
                });
            });
        }
    });
</script>
</body>
</html>